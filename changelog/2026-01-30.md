# Version 2026-01-30

This release introduces four major features that enhance ACP's capability discovery, payment handling, and extensibility.

---

## Capability Negotiation

**Enables agents and sellers to discover and negotiate supported features during checkout.**

Agents declare their capabilities in requests; sellers return the intersection of supported features in responses.

**Key Features:**
- Single `capabilities` object used in both requests and responses
- Intersection semantics: seller computes mutual compatibility
- Early incompatibility detection before payment authorization
- Required field for predictable behavior

**Example:**

```json
// Agent request
{
  "capabilities": {
    "interventions": {
      "supported": ["3ds", "address_verification"],
      "display_context": "webview",
      "max_redirects": 1
    }
  }
}

// Seller response (intersection)
{
  "capabilities": {
    "payment_methods": [
      {
        "method": "card",
        "brands": ["visa", "mastercard"]
      }
    ],
    "interventions": {
      "supported": ["3ds"],  // Intersection of agent + seller
      "required": [],
      "enforcement": "conditional"
    }
  }
}
```

**See:** [Capability Negotiation RFC](../rfcs/rfc.capability_negotiation.md)

---

## Payment Handlers Framework (Breaking Change)

**Replaces simple payment method identifiers with structured handlers.**

**What Changed:**

1. **Declaration:**
   - Old: `payment_provider.supported_payment_methods`
   - New: `capabilities.payment.handlers`

2. **Handler Structure:**
   ```json
   {
     "id": "card_tokenized",
     "name": "dev.acp.tokenized.card",
     "version": "2026-01-22",
     "spec": "https://acp.dev/handlers/...",
     "requires_delegate_payment": true,
     "requires_pci_compliance": false,
     "psp": "stripe",
     "config": {
       "merchant_id": "acct_1234567890",
       "accepted_brands": ["visa", "mastercard"],
       "supports_3ds": true
     }
   }
   ```

3. **Payment Data:**
   - Old: `{ "token": "spt_123", "provider": "stripe" }`
   - New: `{ "handler_id": "card_tokenized", "instrument": { "type": "card", "credential": { "type": "spt", "token": "spt_123" } } }`

**Benefits:**
- Standardized handler discovery
- Explicit security requirements
- PSP identification for credential vaulting
- Handler-specific configuration

**See:** [Payment Handlers RFC](../rfcs/rfc.payment_handlers.md)

---

## Extensions Framework

**Standardized mechanism for optional, composable capabilities.**

Extensions are declared in `capabilities.extensions[]` and integrate with capability negotiation:

```json
{
  "capabilities": {
    "extensions": [
      {
        "namespace": "dev.acp.discount",
        "version": "2026-01-27"
      }
    ]
  }
}
```

**Lifecycle:** Discovery → Negotiation → Usage

**See:** [Extensions Framework RFC](../rfcs/rfc.extensions.md)

### Discount Extension

**Rich discount code support (first ACP extension).**

**Features:**
- Discount code input via `discounts.codes[]`
- Applied discount details with line-item allocations
- Automatic discounts (no code required)
- Rejected codes via `messages[]` with error codes

**Example:**

```json
// Request
{
  "discounts": {
    "codes": ["SUMMER25"]
  }
}

// Response
{
  "discounts": {
    "applied": [
      {
        "id": "discount_123",
        "coupon": {
          "code": "SUMMER25",
          "name": "25% Summer Sale",
          "percent_off": 25.0
        },
        "amount": -2500,
        "allocations": [
          {
            "line_item_id": "item_456",
            "amount": -2500
          }
        ]
      }
    ]
  }
}
```

**Migration:** Optional extension. No changes required for existing implementations.

**See:** [Discount Extension RFC](../rfcs/rfc.discount_extension.md)

---

## Version Compatibility

- API Version: `2026-01-30`
- Previous version `2026-01-22` deprecated
- Payment Handlers: **Breaking change** - requires updates
- Extensions/Discount: **Optional** - adopt incrementally

## Files Updated

**Specifications:**
- `spec/2026-01-30/json-schema/schema.agentic_checkout.json`
- `spec/2026-01-30/json-schema/schema.discount.json` (new)
- `spec/2026-01-30/json-schema/schema.extension.json` (new)
- `spec/2026-01-30/json-schema/schema.delegate_payment.json`
- `spec/2026-01-30/openapi/openapi.agentic_checkout.yaml`
- `spec/2026-01-30/openapi/openapi.delegate_payment.yaml`
- `spec/2026-01-30/openapi/openapi.agentic_checkout_webhook.yaml`

**Examples:**
- `examples/2026-01-30/examples.agentic_checkout.json`
- `examples/2026-01-30/examples.delegate_payment.json`
- `examples/2026-01-30/discount-extension/*.json` (5 examples)

**RFCs:**
- `rfcs/rfc.extensions.md` (new)
- `rfcs/rfc.discount_extension.md` (new)
- `rfcs/rfc.payment_handlers.md` (new)
